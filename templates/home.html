{% load static %}
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Scottish Distilleries</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://d3js.org/d3-array.v1.min.js"></script>
  <script src="https://d3js.org/d3-geo.v1.min.js"></script>
  <script src="https://d3js.org/d3-drag.v1.min.js"></script>
  <script src="https://d3js.org/d3-zoom.v1.min.js"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
  <style>
  body {
    background: #222;
  }

  .debug {
    background: #fff;
    padding: 10px;
  }

  svg {
    border: 1px solid red;
    background: rgba(0, 0, 0, 0);
  }

  #map .country {
    fill: #ddd;
    fill-opacity: 0.6;
    stroke-width: 0.5;
    /* 0.25 to 5 */
    opacity: 0.6;
    /*  0 to 0.5 */
  }
  </style>
  <script>
  document.addEventListener('DOMContentLoaded', function() {

    // Define map size on screen
    var width = 698,
      height = 1032,
      svg, g, path;

    svg = d3.select("body svg")
      .attr("width", width)
      .attr("height", height);

    g = svg.append("g");

    // Align map
    projection = d3.geoMercator()
    // .scale(5000)
    // .center(237922, 692419)
    // .translate([560, 2740]) /* basically arbitrary, trial and error to find these values */
    ;

    path = d3.geoPath()
      .projection(projection);

    d3.json("{% static 'json/topo-scotland.json' %}").then(ready);
    // d3.json("{% static 'json/map.topojson' %}").then(ready);

    d3.select(self.frameElement).style("height", height + "px");
    g.attr("id", "map");

    // DEBUG mouse move on svg
    var debugOutput = document.getElementById('mouse-coordinates');
    document.querySelector('svg').onmousemove = function clicked(evt) {
      var e = evt.target;
      var dim = e.getBoundingClientRect();
      var x = evt.clientX - dim.left;
      var y = evt.clientY - dim.top;
      debugOutput.innerHTML = "x: " + x + " y:" + y;
    }

    function ready(shp, err) {

      window.shp = shp;
      console.warn(shp);

      // Find key to use
      var ks = Object.keys(shp.objects)
      if (ks.length != 1) {
        console.error('need to get this shapefile manually')
        return;
      }
      k = ks[0]

      // Extracting polygons and contours
      var scotland = topojson.feature(shp, shp.objects[k]);

      // Set SVG viewBox instead of fucking with scaling and translating
      // svg.attr("viewBox", `600 0 ${width / 2} ${height / 2}`);
      svg.attr("viewBox", `${width / 2} 0 ${width / 2} ${height / 4}`);

      // Transform if included
      if (Object.keys(shp).includes('transform')) {
        var translate = shp.transform.translate;
        var scale = shp.transform.scale;
        // svg.attr("transform", `translate(${translate[0]} ${translate[0]}) scale(${10/scale[0]} ${10/scale[1]})`)
      }

      // Draw Scotland map
      g.selectAll(".country")
        .data(scotland.features)
        .enter()
        .append("path")
        .attr("class", "country")
        .attr("d", path);

      // function transformPoint(topology, position) {
      //   position = position.slice();
      //   position[0] = position[0] * topology.transform.scale[0] + topology.transform.translate[0]
      //   position[1] = position[1] * topology.transform.scale[1] + topology.transform.translate[1]
      //   return position;
      // }

      // Distillery coordinates
      bowmore = [55.75602, -6.28381];
      auchentoshen = [55.92237, -4.43934];
      jura = [55.83301, -5.95143];
      tomatin = [57.34110, -4.01003];
      highland_park = [58.96701, -2.95222];

      // projection(coords) creates new map-relative values for "coordinates" according to projection used
      // console.log(projection);
      // console.log(projection(bowmore));

      // Add distillery locations to map
      g.selectAll("circle")
        .data([bowmore, auchentoshen, jura, tomatin, highland_park])
        .enter()
        .append("circle")
        .attr("cx", function(d) { console.log(d); console.log(projection(d)); return projection(d)[0]; })
        .attr("cy", function(d) { return projection(d)[1]; })
        .attr("r", "3px")
        .attr("fill", "red");

      svg.call(d3.zoom().on('zoom', function() {
        g.attr("transform", d3.event.transform);
      }))
    }
  });
  </script>
</head>

<body>
  <p id="mouse-coordinates" class="debug">x: -- y: --</p>
  <svg>
</body>

</html>