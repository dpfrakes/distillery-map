{% load static %}
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Scottish Distilleries</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://d3js.org/d3-array.v1.min.js"></script>
  <script src="https://d3js.org/d3-geo.v1.min.js"></script>
  <script src="https://d3js.org/d3-drag.v1.min.js"></script>
  <script src="https://d3js.org/d3-zoom.v1.min.js"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
  <style>
  body {
    background: #222;
  }

  .debug {
    background: #fff;
    padding: 10px;
  }

  svg {
    border: 1px solid red;
    background: rgba(0, 0, 0, 0);
  }

  #map .country {
    fill: #ddd;
    fill-opacity: 0.6;
    stroke-width: 0.5;
    /* 0.25 to 5 */
    opacity: 0.6;
    /*  0 to 0.5 */
  }
  </style>
  <script>
  document.addEventListener('DOMContentLoaded', function() {

    // Define map size on screen
    // var width = 600,
    //   height = 800,
    var width = 500,
      height = 800,
      svg, g, path;

    svg = d3.select("body svg")
      .attr("width", width)
      .attr("height", height);

    g = svg.append("g");

    d3.json("{% static 'json/topo-scotland.json' %}").then(ready);

    // Align map
    projection = d3.geoMercator()
      .translate([width / 2 + 230, height * 5 + 100])
      .scale(3000)
      // .center(237922, 692419)
      // .center(0, 0)
      // .translate([560, 2550]); /* basically arbitrary, trial and error to find these values */

    path = d3.geoPath()
      .projection(projection);

    d3.select(self.frameElement).style("height", height + "px");
    g.attr("id", "map");

    // DEBUG mouse move on svg
    var debugOutput = document.getElementById('mouse-coordinates');
    document.querySelector('svg').onmousemove = function clicked(evt) {
      var e = evt.target;
      var dim = e.getBoundingClientRect();
      var x = evt.clientX - dim.left;
      var y = evt.clientY - dim.top;
      debugOutput.innerHTML = "x: " + x + " y:" + y;
    }

    function ready(shp, err) {

      window.shp = shp;
      console.warn(shp);

      // // Find key to use
      // var ks = Object.keys(shp.objects)
      // if (ks.length != 1) {
      //   console.error('need to get this shapefile manually')
      //   return;
      // }
      // k = ks[0]

      // var scotland = topojson.feature(shp, shp.objects[k]);

      // // Set SVG viewBox instead of fucking with scaling and translating
      // // svg.attr("viewBox", `600 0 ${width / 2} ${height / 2}`);
      // svg.attr("viewBox", `${width / 2} 0 ${width / 2} ${height / 4}`);

      // // Transform if included
      // if (Object.keys(shp).includes('transform')) {
      //   var translate = shp.transform.translate;
      //   var scale = shp.transform.scale;
      //   // svg.attr("transform", `translate(${translate[0]} ${translate[0]}) scale(${10/scale[0]} ${10/scale[1]})`)
      // }

      // Extracting polygons and contours
      var scotland = topojson.feature(shp, shp.objects.eer);

      // Draw Scotland map
      g.selectAll(".country")
        .data(scotland.features)
        .enter()
        .append("path")
        .attr("class", "country")
        .attr("d", path);

      // points
      CENTER_OF_EARTH = [0, 0];
      points = [];
      for (i = 0; i <= 9; i++) {
        points.push([0, i * 10]);
      }

      bowmore = [55.75602, -6.28381];
      auchentoshen = [55.92237, -4.43934];
      jura = [55.83301, -5.95143];
      tomatin = [57.34110, -4.01003];
      highland_park = [58.96701, -2.95222];

      points = [bowmore, auchentoshen, jura, tomatin, highland_park]

      // Switch lat/long
      points = points.map((c) => [c[1], c[0]])

      // add states from topojson
      // svg.selectAll("path")
      //   .data(scotland).enter()
      //   .append("path")
      //   .attr("class", "feature")
      //   .style("fill", "steelblue")
      //   .attr("d", path);

      // function transformPoint(topology, position) {
      //   position = position.slice();
      //   position[0] = position[0] * topology.transform.scale[0] + topology.transform.translate[0]
      //   position[1] = position[1] * topology.transform.scale[1] + topology.transform.translate[1]
      //   return position;
      // }

      console.log(points);

      // Add distillery locations to map
      g.selectAll("circle")
        .data(points)
        .enter()
        .append("circle")
        .attr("cx", function(d) { return projection(d)[0]; })
        .attr("cy", function(d) { return projection(d)[1]; })
        .attr("r", "2px")
        .attr("fill", "red");

      svg.call(d3.zoom().on('zoom', function() {
        g.attr("transform", d3.event.transform);

        dynamicScale = document.querySelector('g')
          .getAttribute('transform')
          .match(/.*(scale\(.*\)).*/)[1]
          .match(/\((.*)\)/)[1];

        // Add distillery locations to map
        svg.selectAll("circle")
          .remove();

        g.selectAll("circle")
          .data(points)
          .enter()
          .append("circle")
          .attr("cx", function(d) { return projection(d)[0]; })
          .attr("cy", function(d) { return projection(d)[1]; })
          .attr("r", 2 / Math.sqrt(dynamicScale) + "px")
          .attr("fill", "red");
        }));
    }
  });
  </script>
</head>

<body>
  <p id="mouse-coordinates" class="debug">x: -- y: --</p>
  <svg>
</body>

</html>